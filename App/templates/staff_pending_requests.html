{% extends "staff_layout.html" %} {% block styles %}
<style>
  .sub-container {
    display: flex;
    flex-direction: column;
    padding: 20px;
    gap: 20px;
    box-shadow: rgba(50, 50, 93, 0.25) 0px 2px 5px -1px,
      rgba(0, 0, 0, 0.3) 0px 1px 3px -1px;
  }
  .top-bar {
    color: white;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px, rgba(0, 0, 0, 0.23) 0px 3px 6px;
    background: #0da1db;
    background: linear-gradient(
      214deg,
      rgba(13, 161, 219, 0.6) 0%,
      rgba(46, 134, 179, 0.57) 50%,
      rgba(36, 164, 214, 0.69) 100%
    );
  }
  .filter-section {
    display: flex;
    flex-direction: column;
  }
  .filters {
    padding: 2px 10px;
    box-shadow: rgba(50, 50, 93, 0.25) 0px 2px 5px -1px,
      rgba(0, 0, 0, 0.3) 0px 1px 3px -1px;
    background-color: rgba(252, 252, 252, 0.7);
  }
  .control-buttons {
    padding: 10px;
    display: flex;
    flex-direction: row;
    gap: 15px;
  }
  .requests-section {
    color: white;
    display: flex;
    flex-direction: column;
    gap: 5px;
    height: 450px;
    padding: 15px;
    box-shadow: rgba(50, 50, 93, 0.25) 0px 2px 5px -1px,
      rgba(0, 0, 0, 0.3) 0px 1px 3px -1px;
  }
  .scroll-section {
    display: flex;
    flex-direction: column;
    gap: 5px;
    overflow-y: scroll;
  }
  .request-card {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    box-shadow: rgba(0, 0, 0, 0.16) 0px 3px 6px, rgba(0, 0, 0, 0.23) 0px 3px 6px;
    background: #0da1db;
    background: linear-gradient(
      214deg,
      rgba(13, 161, 219, 0.6) 0%,
      rgba(46, 134, 179, 0.57) 50%,
      rgba(36, 164, 214, 0.69) 100%
    );
  }
  .card-even {
    background: #0da1db;
    background: linear-gradient(
      214deg,
      rgba(13, 161, 219, 0.6) 0%,
      rgba(46, 134, 179, 0.57) 50%,
      rgba(36, 164, 214, 0.69) 100%
    );
  }
  .card-odd {
    background: #0d74db;
    background: linear-gradient(
      214deg,
      rgba(13, 116, 219, 0.6) 0%,
      rgba(46, 117, 179, 0.57) 49%,
      rgba(36, 107, 214, 0.69) 100%
    );
  }
  .student-info {
    display: flex;
    flex-direction: column;
    width: 70%;
  }
  .request-info {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: baseline;
  }
  .request-actions {
    margin-top: 20px;
    display: flex;
    gap: 20px;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
  }
  .view-details {
    text-decoration: underline;
  }
  .view-details:hover {
    cursor: pointer;
  }
</style>
{% endblock %} {% block content %}
<div class="container" style="margin-top: 20px">
  {# flash messages #} {% with messages =
  get_flashed_messages(with_categories=true) %} {% if messages %} {% for
  category, msg in messages %}
  <div
    id="flash-message"
    class="card-panel {{ 'red lighten-4' if category == 'error' else 'green lighten-4' }}"
  >
    {{ msg }}
  </div>
  {% endfor %} {% endif %} {% endwith %}
  <div class="sub-container">
    <div class="top-bar">
      <div class="filter-section">
        <h5>Pending Student Requests ({{num_pending}})</h5>
        <div class="input-field col s12 filters">
          <select id="sortFilter">
            <option value="" disabled selected>Sort by</option>
            <option value="oldest">Oldest First</option>
            <option value="newest">Newest First</option>
          </select>
        </div>
      </div>
      <div class="control-buttons">
        {% if num_pending > 0 %}
        <button
          class="btn green lighten-2 waves-effect"
          onclick="openConfirmModal('approve_all', 0)"
          type="button"
        >
          Approve
        </button>

        <button
          class="btn red lighten-2 waves-effect"
          onclick="openConfirmModal('deny_all', 0)"
          type="button"
        >
          Deny
        </button>
        {% endif %}
      </div>
    </div>
    <div class="requests-section">
      <div class="scroll-section" id="pending-list">
        {%for pending_req in pending_requests %}
        <div
          class="request-card {{ 'card-even' if loop.index0 % 2 == 0 else 'card-odd' }}"
          data-date="{{ pending_req.date_created.isoformat() }}"
        >
          <div class="student-info">
            <h6><strong>Student ID:</strong> {{pending_req.student_id}}</h6>
            <h6><strong>Hours Requested:</strong>{{pending_req.hours}}</h6>
            <div class="request-info">
              <h5>Request Title: {{pending_req.title}}</h5>
              <h6><strong>Date: {{pending_req.date_created}}</strong></h6>
            </div>
          </div>
          <div class="request-actions">
            <div class="control-buttons">
              <button
                class="btn green lighten-2 waves-effect"
                onclick="openConfirmModal('approve_request', {{ pending_req.id }})"
                type="button"
              >
                Approve
              </button>

              <button
                class="btn red lighten-2 waves-effect"
                onclick="openConfirmModal('deny_request', {{ pending_req.id }})"
                type="button"
              >
                Deny
              </button>
            </div>
            <div
              class="view-details"
              data-title="{{ pending_req.title }}"
              data-hours="{{ pending_req.hours }}"
              data-description="{{ pending_req.description or ' ' }}"
              onclick="openDetailsModal(this)"
            >
              View Details >
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h4 id="modalTitle"></h4>
    <p id="modalMessage"></p>
  </div>

  <div class="modal-footer">
    <form id="modalForm" method="POST">
      <button type="submit" class="btn green lighten-2">Confirm</button>
      <button type="button" class="modal-close btn red lighten-2">
        Cancel
      </button>
    </form>
  </div>
</div>
<!-- View Details Modal -->
<div id="detailsModal" class="modal">
  <div class="modal-content">
    <h4 id="detailsModalTitle">Request Details</h4>
    <p><strong>Title:</strong> <span id="detailsTitle"></span></p>
    <p><strong>Hours:</strong> <span id="detailsHours"></span></p>
    <p><strong>Description:</strong> <span id="detailsDescription"></span></p>
  </div>
  <div class="modal-footer">
    <button type="button" class="modal-close btn red lighten-2">Close</button>
  </div>
</div>

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var selects = document.querySelectorAll("select");
    M.FormSelect.init(selects);

    const modals = document.querySelectorAll(".modal");
    M.Modal.init(modals);

    document
      .getElementById("sortFilter")
      .addEventListener("change", function () {
        const sort = this.value;
        const list = document.getElementById("pending-list");
        const cards = Array.from(list.children);

        cards.sort((a, b) => {
          const dateA = new Date(a.dataset.date);
          const dateB = new Date(b.dataset.date);
          return sort === "oldest" ? dateA - dateB : dateB - dateA;
        });

        cards.forEach((card) => list.appendChild(card));
      });
  });
  function openConfirmModal(action, reqId) {
    const modal = M.Modal.getInstance(document.getElementById("confirmModal"));

    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");

    const isApprove =
      (reqId === 0 && action === "approve_all") || action === "approve_one";

    modalTitle.innerText =
      reqId === 0
        ? isApprove
          ? "Approve All Requests"
          : "Deny All Requests"
        : isApprove
        ? "Approve Request"
        : "Deny Request";

    modalMessage.innerText =
      reqId === 0
        ? isApprove
          ? "Are you sure you want to approve all requests?"
          : "Are you sure you want to deny all requests?"
        : isApprove
        ? "Are you sure you want to approve this request?"
        : "Are you sure you want to deny this request?";

    document.getElementById(
      "modalForm"
    ).action = `/staff/pending?action=${action}&request_id=${reqId}`;

    modal.open();
  }
  function openDetailsModal(request) {
    const modal = M.Modal.getInstance(document.getElementById("detailsModal"));

    document.getElementById("detailsTitle").innerText = request.dataset.title;
    document.getElementById("detailsHours").innerText = request.dataset.hours;
    document.getElementById("detailsDescription").innerText =
      request.dataset.description || "N/A";

    modal.open();
  }
  setTimeout(() => {
    document.querySelectorAll("#flash-message").forEach((msg) => {
      msg.style.transition = "opacity 0.5s";
      msg.style.opacity = 0;
      setTimeout(() => msg.remove(), 500);
    });
  }, 5000);
</script>
{% endblock %} {%endblock%}
