{% extends "staff_layout.html" %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='staff_pending_requests_style.css') }}">
{% endblock %}

{% block content %}
<div class="staff-page">
  {# flash messages #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div id="flash-message" class="card-panel
                    {% if category == 'error' %}
                      staff-flash-error
                    {% else %}
                      staff-flash-success
                    {% endif %}">
          {{ msg }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="staff-main">
    <div class="staff-header">
      <h3>Pending Student Requests</h3>
      <p>Review and approve or deny student activity hour requests. Use filters and bulk actions to manage requests efficiently.</p>
    </div>

    <!-- HEADER CARD WITH FILTERS AND BULK ACTIONS -->
    <div class="requests-header-card">
      <div class="header-content">
        <div class="header-left">
          <div class="pending-count">
            <h5 class="count-number">{{ num_pending }}</h5>
            <p class="count-label">Pending Requests</p>
          </div>
        </div>

        <div class="header-middle">
          <div class="filter-group">
            <label for="sortFilter">Sort by:</label>
            <select id="sortFilter" class="staff-select">
              <option value="" disabled selected>Select</option>
              <option value="oldest">Oldest First</option>
              <option value="newest">Newest First</option>
            </select>
          </div>
        </div>

        <div class="header-right">
          {% if num_pending > 0 %}
          <button class="btn staff-btn-primary waves-effect"
                  onclick="openConfirmModal('approve_all', 0)" type="button">
            Approve All
          </button>
          <button class="btn staff-btn-danger waves-effect"
                  onclick="openConfirmModal('deny_all', 0)" type="button">
            Deny All
          </button>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- REQUESTS LIST -->
    <div class="requests-list-card">
      <div class="requests-list" id="pending-list">
        {% if pending_requests %}
          {% for pending_req in pending_requests %}
          <div class="request-card" data-date="{{ pending_req.date_created.isoformat() }}">
            <!-- LEFT: STUDENT INFO -->
            <div class="card-left">
              <div class="student-id-badge">
                <span class="badge-label">ID</span>
                <span class="badge-value">{{ pending_req.student_id }}</span>
              </div>
              <div class="student-details">
                <h6 class="request-title">{{ pending_req.title }}</h6>
                <p class="request-meta">
                  <span class="meta-item"><strong>Hours:</strong> {{ pending_req.hours }}</span>
                  <span class="meta-separator">•</span>
                  <span class="meta-item"><strong>Date:</strong> {{ pending_req.date_created.strftime('%b %d, %Y') }}</span>
                </p>
                {% if pending_req.description %}
                <p class="request-description">{{ pending_req.description }}</p>
                {% endif %}
              </div>
            </div>

            <!-- RIGHT: ACTIONS -->
            <div class="card-right">
              <button class="btn-action btn-approve"
                      onclick="openConfirmModal('approve_request', {{ pending_req.id }})"
                      title="Approve request" type="button">
                ✓ Approve
              </button>
              <button class="btn-action btn-deny"
                      onclick="openConfirmModal('deny_request', {{ pending_req.id }})"
                      title="Deny request" type="button">
                ✕ Deny
              </button>
              <button class="btn-action btn-details"
                      data-title="{{ pending_req.title }}"
                      data-hours="{{ pending_req.hours }}"
                      data-description="{{ pending_req.description or 'No description provided.' }}"
                      onclick="openDetailsModal(this)"
                      title="View full details" type="button">
                Details
              </button>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="requests-empty">
            <p>No pending requests at this time.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h4 id="modalTitle" style="margin-top: 0; color: #1b4332;"></h4>
    <p id="modalMessage" style="color: #6c757d;"></p>
  </div>
  <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 16px 24px;">
    <button type="button" class="modal-close btn grey lighten-1" style="color: #1b4332; margin: 0;">Cancel</button>
    <form id="modalForm" method="POST" style="margin: 0;">
      <button type="submit" class="btn staff-btn-primary" style="margin: 0;">Confirm</button>
    </form>
  </div>
</div>

<!-- View Details Modal -->
<div id="detailsModal" class="modal">
  <div class="modal-content">
    <h4 style="margin-top: 0; color: #1b4332;">Request Details</h4>
    <div class="details-group">
      <p class="details-label">Title</p>
      <p class="details-value" id="detailsTitle"></p>
    </div>
    <div class="details-group">
      <p class="details-label">Hours</p>
      <p class="details-value" id="detailsHours"></p>
    </div>
    <div class="details-group">
      <p class="details-label">Description</p>
      <p class="details-value" id="detailsDescription"></p>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="modal-close btn grey lighten-1" style="color: #1b4332;">Close</button>
  </div>
</div>

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var selects = document.querySelectorAll("select");
    M.FormSelect.init(selects);

    const modals = document.querySelectorAll(".modal");
    M.Modal.init(modals);

    document.getElementById("sortFilter").addEventListener("change", function () {
      const sort = this.value;
      const list = document.getElementById("pending-list");
      const cards = Array.from(list.children).filter(c => c.classList.contains("request-card"));

      cards.sort((a, b) => {
        const dateA = new Date(a.dataset.date);
        const dateB = new Date(b.dataset.date);
        return sort === "oldest" ? dateA - dateB : dateB - dateA;
      });

      cards.forEach((card) => list.appendChild(card));
    });
  });

  function openConfirmModal(action, reqId) {
    const modal = M.Modal.getInstance(document.getElementById("confirmModal"));
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
    const isApprove = (reqId === 0 && action === "approve_all") || action === "approve_request";

    modalTitle.innerText = reqId === 0
      ? (isApprove ? "Approve All Requests?" : "Deny All Requests?")
      : (isApprove ? "Approve Request?" : "Deny Request?");

    modalMessage.innerText = reqId === 0
      ? (isApprove ? "This action will approve all pending requests." : "This action will deny all pending requests.")
      : (isApprove ? "Are you sure you want to approve this request?" : "Are you sure you want to deny this request?");

    document.getElementById("modalForm").action = `/staff/pending?action=${action}&request_id=${reqId}`;
    modal.open();
  }

  function openDetailsModal(button) {
    const modal = M.Modal.getInstance(document.getElementById("detailsModal"));
    document.getElementById("detailsTitle").innerText = button.dataset.title;
    document.getElementById("detailsHours").innerText = button.dataset.hours + " hours";
    document.getElementById("detailsDescription").innerText = button.dataset.description;
    modal.open();
  }

  setTimeout(() => {
    document.querySelectorAll("#flash-message").forEach((msg) => {
      msg.style.transition = "opacity 0.5s";
      msg.style.opacity = 0;
      setTimeout(() => msg.remove(), 500);
    });
  }, 5000);
</script>
{% endblock %}

{% endblock %}
